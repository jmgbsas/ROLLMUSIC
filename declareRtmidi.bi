 
#Include once  "file.bi"
#include "mod_rtmidi_c.bi"
#Inclib  "rtmidi.dll"
#include "fbthread.bi"
#Include "crt.bi" ' QSORT

dim Shared midiin As   RtMidiInPtr 
dim Shared midiout As  RtMidiOutPtr
Declare Sub noteon	( note As UByte, vel As UByte,canal As integer) 
Declare sub noteoff( note As UByte, canal As integer)
Declare Sub note2on	( note1 As UByte, note2 As UByte, vel As UByte,canal As integer)
Declare Sub note2off	( note1 As UByte, note2 As UByte, canal As integer)
Declare Sub note3on	( note1 As UByte, note2 As UByte, note3 As UByte, vel As UByte,canal As integer)
Declare Sub note3off	( note1 As UByte, note2 As UByte, note3 As UByte, canal As integer)
Declare Sub note4on	( note1 As UByte, note2 As UByte, note3 As UByte, note4 As UByte, vel As UByte,canal As integer)
Declare Sub note4off	( note1 As UByte, note2 As UByte, note3 As UByte, note4 As UByte, canal As integer)
Declare Sub note5on	( note1 As UByte, note2 As UByte, note3 As UByte, note4 As UByte, note5 As UByte, vel As UByte, canal As integer)
Declare Sub note5off	( note1 As UByte, note2 As UByte, note3 As UByte, note4 As UByte,note5 As UByte, canal As integer)
Declare Function restar (notaRoll As Integer) As Integer
Declare Sub PlayRoll ( )
declare Sub playAll() 
Declare Sub duracion (dura As Integer)
Declare Sub pedaloff()
Declare Sub allSoundoff(canal As Integer)
Declare Sub alloff(canal As Integer )
Declare Sub listports( )
Declare Sub sleep5dm()

Dim Shared message(1 To 21) As UByte ' message output 

' maximo seria para un acorde de 5 por ejemplo
' 5 notas + velocidad y canal = 7 bytes...para note on
' si tomamos 10 dedos de las 2 manos serian 10 notas+ vel + canal = 12
' si agregamos velocidad distinta para cada nota serian
' 20 mas canal = 21 bytes...maximo 
' podriamos agregar presion promedio aftertouch etc pero serin mensajes independientes 
Dim errorString As ZString Ptr
Dim Shared p as UBYTE Ptr = @message(1) 
Dim size As UInteger<64> 
Dim sizeptr As UInteger<64> Ptr = @size
Dim Shared As UInteger portsin, portsout 
Dim Shared As Double tiempoPatron=60 ' cuantas negras enun minuto default
Dim Shared As Double old_time=0
Dim Shared As Integer jply=0, finplay=0
'elpatron esla negra ej I=60ergo todo sera relativo  la negra
Dim Shared As float relDur (1 To 182) => { _ 
4 ,2 , 1.0, 0.50,0.250,0.1250 ,0.06250,0.031250,0.0156250, _ ' 1 9 
5 ,2.5,1.25,0.625,0.3125,0.15625,0.078125,0.0390625,0.01953125,_ ' 10 18
6 ,3 , 1.5, 0.75,0.375,0.1875 ,0.09375,0.046875,0.0234375, _ ' 19 27
7 ,3.5,1.75,0.875,0.4375,0.21875,0.109375,0.0546875,0.02734375, _ '28 36
2.666666,1.333333,0.666666,0.333333,0.166666,0.083333,0.041666,0.208333,0.01041666, _ '37 45
4 ,2 , 1.0, 0.50,0.250,0.1250 ,0.06250,0.031250,0.0156250, _ ' 46 54
5 ,2.5,1.25,0.625,0.3125,0.15625,0.078125,0.0390625,0.01953125,_ ' 55 63
6 ,3 , 1.5, 0.75,0.375,0.1875 ,0.09375,0.046875,0.0234375, _ '  64 72
7 ,3.5,1.75,0.875,0.4375,0.21875,0.109375,0.0546875,0.02734375, _ ' 73 81
2.666666,1.333333,0.666666,0.333333,0.166666,0.083333,0.041666,0.208333,0.01041666, _ '82 90
4 ,2 , 1.0, 0.50,0.250,0.1250 ,0.06250,0.031250,0.0156250, _ ' 91 99
5 ,2.5,1.25,0.625,0.3125,0.15625,0.078125,0.0390625,0.01953125,_ ' 100 108
6 ,3 , 1.5, 0.75,0.375,0.1875 ,0.09375,0.046875,0.0234375, _ ' 109 117
7 ,3.5,1.75,0.875,0.4375,0.21875,0.109375,0.0546875,0.02734375, _ ' 118 126
2.666666,1.333333,0.666666,0.333333,0.166666,0.083333,0.041666,0.208333,0.01041666, _ ' 127 135
4 ,2 , 1.0, 0.50,0.250,0.1250 ,0.06250,0.031250,0.0156250, _ ' 136 144
5 ,2.5,1.25,0.625,0.3125,0.15625,0.078125,0.0390625,0.01953125,_ ' 145 153
6 ,3 , 1.5, 0.75,0.375,0.1875 ,0.09375,0.046875,0.0234375, _ ' 154 162
7 ,3.5,1.75,0.875,0.4375,0.21875,0.109375,0.0546875,0.02734375, _ '163 171
2.666666,1.333333,0.666666,0.333333,0.166666,0.083333,0.041666,0.0208333,0.01041666,0,0} '172 181

Dim Shared As Integer play =0,playb=0, portout, portin 
ReDim Shared As string listout(1 ), listin (1 ) 
'----------------------------
' PLAY ALL NEW
Declare Function QCompare Cdecl (Byval e1 As Any Ptr, Byval e2 As Any Ptr) As Integer
Type Re   ' de relaciones
 ordRelDur As UByte ' orden de reldur ascendente
 relDur As Double ' durcion relativa a la negra
 Dur As UByte   ' nuemrcion de figura
 SonyLiga As UByte
End Type
' ENTRO CON DUR SALGO CON EL ORDEN DEL TIEMPO DEL RELDUR
Dim Shared Datos1 (1 To 180) As UByte => _
{165,145,125,105,85,62,42,22,5,169,149,129,109,89,66,46,26,9,173,157,137, _
 117,97,74,54,34,14,177,161,141,121,101,81,58,38,18,153,133,113,93,70,50, _
 30,78,1,166,146,126,106,86,63,43,23,6,170,150,130,110,90,67,47,27,10,174, _
 158,138,118,98,75,55,35,15,178,162,142,122,102,82,59,39,19,154,134,114,94, _
 71,51,31,79,2,167,147,127,107,87,64,44,24,7,171,151,131,111,91,68,48,28,11, _
 175,159,139,119,99,76,56,36,16,179,163,143,123,103,83,60,40,20,155,135,115, _
 95,72,52,32,80,3,168,148,128,108,88,65,45,25,8,172,152,132,112,92,69,49,29, _
 12,176,160,140,120,100,77,57,37,17,180,164,144,124,104,84,61,41,21,156,136, _
 116,96,73,53,33,13,4 }
 
 'sort por reldur,ENTRO POR ORDRELDUR ELORDEN DEL TIEMPO SACADO DE DATOS1
'EN L 3ER POSICIN ESTA dur CON Laqtmbientengola figura y notapiano¿? 
Dim Shared Datos4 (1 To 180) As Re => { _
( 1,0.01041666,45,0), _
( 2,0.01041666,90,2), _
( 3,0.01041666,135,4), _
( 4,0.01041666,180,4), _
( 5,0.0156250,9,1), _
( 6,0.0156250,54,0), _
( 7,0.0156250,99,2), _
( 8,0.0156250,144,4), _
( 9,0.01953125,18,1), _
( 10,0.01953125,63,0), _
( 11,0.01953125,108,2), _
( 12,0.01953125,153,4), _
( 13,0.0208333,179,4), _
( 14,0.0234375,27,1), _
( 15,0.0234375,72,0), _
( 16,0.0234375,117,2), _
( 17,0.0234375,162,4), _
( 18,0.02734375,36,1), _
( 19,0.02734375,81,0), _
( 20,0.02734375,126,2), _
( 21,0.02734375,171,4), _
( 22,0.031250,8,1), _
( 23,0.031250,53,0), _
( 24,0.031250,98,2), _
( 25,0.031250,143,4), _
( 26,0.0390625,17,1), _
( 27,0.0390625,62,0), _
( 28,0.0390625,107,2), _
( 29,0.0390625,152,4), _
( 30,0.041666,43,1), _
( 31,0.041666,88,0), _
( 32,0.041666,133,2), _
( 33,0.041666,178,4), _
( 34,0.046875,26,1), _
( 35,0.046875,71,0), _
( 36,0.046875,116,2), _
( 37,0.046875,161,4), _
( 38,0.0546875,35,1), _
( 39,0.0546875,80,0), _
( 40,0.0546875,125,2), _
( 41,0.0546875,170,4), _
( 42,0.06250,7,1), _
( 43,0.06250,52,0), _
( 44,0.06250,97,2), _
( 45,0.06250,142,4), _
( 46,0.078125,16,1), _
( 47,0.078125,61,0), _
( 48,0.078125,106,2), _
( 49,0.078125,151,4), _
( 50,0.083333,42,1), _
( 51,0.083333,87,0), _
( 52,0.083333,132,2), _
( 53,0.083333,177,4), _
( 54,0.09375,25,1), _
( 55,0.09375,70,0), _
( 56,0.09375,115,2), _
( 57,0.09375,160,4), _
( 58,0.109375,34,1), _
( 59,0.109375,79,0), _
( 60,0.109375,124,2), _
( 61,0.109375,169,4), _
( 62,0.1250,6,1), _
( 63,0.1250,51,0), _
( 64,0.1250,96,2), _
( 65,0.1250,141,4), _
( 66,0.15625,15,1), _
( 67,0.15625,60,0), _
( 68,0.15625,105,2), _
( 69,0.15625,150,4), _
( 70,0.166666,41,1), _
( 71,0.166666,86,0), _
( 72,0.166666,131,2), _
( 73,0.166666,176,4), _
( 74,0.1875,24,1), _
( 75,0.1875,69,0), _
( 76,0.1875,114,2), _
( 77,0.1875,159,4), _
( 78,0.208333,44,1), _
( 79,0.208333,89,0), _
( 80,0.208333,134,2), _
( 81,0.21875,33,1), _
( 82,0.21875,78,0), _
( 83,0.21875,123,2), _
( 84,0.21875,168,4), _
( 85,0.250,5,1), _
( 86,0.250,50,0), _
( 87,0.250,95,2), _
( 88,0.250,140,4), _
( 89,0.3125,14,1), _
( 90,0.3125,59,0), _
( 91,0.3125,104,2), _
( 92,0.3125,149,4), _
( 93,0.333333,40,1), _
( 94,0.333333,85,0), _
( 95,0.333333,130,2), _
( 96,0.333333,175,4), _
( 97,0.375,23,1), _
( 98,0.375,68,0), _
( 99,0.375,113,2), _
( 100,0.375,158,4), _
( 101,0.4375,32,1), _
( 102,0.4375,77,0), _
( 103,0.4375,122,2), _
( 104,0.4375,167,4), _
( 105,0.50,4,1), _
( 106,0.50,49,0), _
( 107,0.50,94,2), _
( 108,0.50,139,4), _
( 109,0.625,13,1), _
( 110,0.625,58,0), _
( 111,0.625,103,2), _
( 112,0.625,148,4), _
( 113,0.666666,39,1), _
( 114,0.666666,84,0), _
( 115,0.666666,129,2), _
( 116,0.666666,174,4), _
( 117,0.75,22,1), _
( 118,0.75,67,0), _
( 119,0.75,112,2), _
( 120,0.75,157,4), _
( 121,0.875,31,1), _
( 122,0.875,76,0), _
( 123,0.875,121,2), _
( 124,0.875,166,4), _
( 125,1.0,3,1), _
( 126,1.0,48,0), _
( 127,1.0,93,2), _
( 128,1.0,138,4), _
( 129,1.25,12,1), _
( 130,1.25,57,0), _
( 131,1.25,102,2), _
( 132,1.25,147,4), _
( 133,1.333333,38,1), _
( 134,1.333333,83,0), _
( 135,1.333333,128,2), _
( 136,1.333333,173,4), _
( 137,1.5,21,1), _
( 138,1.5,66,0), _
( 139,1.5,111,2), _
( 140,1.5,156,4), _
( 141,1.75,30,1), _
( 142,1.75,75,0), _
( 143,1.75,120,2), _
( 144,1.75,165,4), _
( 145,2.0,2,1), _
( 146,2.0,47,0), _
( 147,2.0,92,2), _
( 148,2.0,137,4), _
( 149,2.5,11,1), _
( 150,2.5,56,0), _
( 151,2.5,101,2), _
( 152,2.5,146,4), _
( 153,2.666666,37,1), _
( 154,2.666666,82,0), _
( 155,2.666666,127,2), _
( 156,2.666666,172,4), _
( 157,3.0,20,1), _
( 158,3.0,65,0), _
( 159,3.0,110,2), _
( 160,3.0,155,4), _
( 161,3.5,29,1), _
( 162,3.5,74,0), _
( 163,3.5,119,2), _
( 164,3.5,164,4), _
( 165,4.0,1,1), _
( 166,4.0,46,0), _
( 167,4.0,91,2), _
( 168,4.0,136,4), _
( 169,5.0,10,1), _
( 170,5.0,55,0), _
( 171,5.0,100,2), _
( 172,5.0,145,4), _
( 173,6.0,19,1), _
( 174,6.0,64,0), _
( 175,6.0,109,2), _
( 176,6.0,154,4), _
( 177,7.0,28,1), _
( 178,7.0,73,0), _
( 179,7.0,118,2), _
( 180,7.0,163,4) }

'en vec debo agregar la nota piano
Type vec
   DUR As Integer 'DUR
   ordRelDur As integer ' orden de DUR
   notapiano As Integer ' del piano real
   liga      As Integer 
End Type


